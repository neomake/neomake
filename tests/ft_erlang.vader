Include: include/setup.vader

Execute (erlang#erlc: common settings):
  new
  file src/myapp.erl

  let args = neomake#makers#ft#erlang#ErlcArgs(getcwd(), [])
  AssertEqual args[:-2], ['-pa', 'ebin', '-I', 'include', '-I', 'src', '-o']
  let output_dir = args[-1]
  Assert isdirectory(output_dir)
  bwipe

Execute (erlang#erlc: output to _build/neomake if _build is present):
  let old_cwd = getcwd()
  try
    let root = tempname()
    call mkdir(root, 'p')
    execute 'cd ' . root

    call mkdir('_build', 'p')
    new
    file src/myapp.erl

    let args = neomake#makers#ft#erlang#ErlcArgs(getcwd(), [])
    let output_dir = args[-1]
    Assert output_dir =~# '/_build/neomake$'
    Assert isdirectory(output_dir)
    bwipe
  finally
    execute 'cd ' . old_cwd
  endtry

Execute (erlang#EbinDirs: rebar3 default profile - no rebar.config):
  let old_cwd = getcwd()
  try
    let root = tempname()
    call mkdir(root, 'p')
    execute 'cd ' . root

    call mkdir('_build/default/lib/dep1/ebin', 'p')
    new
    file src/myapp.erl

    let ebins = neomake#makers#ft#erlang#EbinDirs(root)
    AssertEqual [root . '/_build/default/lib/dep1/ebin'], ebins
    bwipe
  finally
    execute 'cd ' . old_cwd
  endtry


Execute (erlang#EbinDirs: rebar3 default profile):
  let old_cwd = getcwd()
  try
    let root = tempname()
    call mkdir(root, 'p')
    execute 'cd ' . root

    call mkdir('_build/default/lib/dep1/ebin', 'p')
    write rebar.config
    bwipe rebar.config
    new
    file src/myapp.erl

    let ebins = neomake#makers#ft#erlang#EbinDirs(root)
    AssertEqual [root . '/_build/default/lib/dep1/ebin'], ebins
    bwipe
  finally
    execute 'cd ' . old_cwd
  endtry

Execute (erlang#EbinDirs: rebar3 test profile):
  let old_cwd = getcwd()
  try
    let root = tempname()
    call mkdir(root, 'p')
    execute 'cd ' . root

    call mkdir('_build/test/lib/dep1/ebin', 'p')
    new
    file test/myapp_SUITE.erl

    let ebins = neomake#makers#ft#erlang#EbinDirs(root)
    AssertEqual [root . '/_build/test/lib/dep1/ebin'], ebins
    bwipe
  finally
    execute 'cd ' . old_cwd
  endtry

Execute (erlang#EbinDirs: rebar2/erlang.mk deps/ present):
  let old_cwd = getcwd()
  try
    let root = tempname()
    call mkdir(root, 'p')
    execute 'cd ' . root

    call mkdir('deps/dep1/ebin', 'p')
    new
    file src/myapp.erl

    let ebins = neomake#makers#ft#erlang#EbinDirs(root)
    AssertEqual [root . '/deps/dep1/ebin'], ebins
    bwipe
  finally
    execute 'cd ' . old_cwd
  endtry

Execute (erlang#EbinDirs: buffer local extra deps):
  let old_cwd = getcwd()
  try
    let root = tempname()
    call mkdir(root, 'p')
    execute 'cd ' . root

    call mkdir('deps.local/dep1/ebin', 'p')
    new
    file src/myapp.erl
    let b:neomake_erlang_erlc_extra_deps = ['deps.local']

    let ebins = neomake#makers#ft#erlang#EbinDirs(root)
    AssertEqual ['deps.local/dep1/ebin'], ebins
    bwipe
  finally
    execute 'cd ' . old_cwd
  endtry

Execute (erlang#EbinDirs: buffer local profile override):
  let old_cwd = getcwd()
  try
    let root = tempname()
    call mkdir(root, 'p')
    execute 'cd ' . root

    call mkdir('_build/test/lib/dep1/ebin', 'p')
    new
    file config/not_a_SUITE_file.erl
    let b:neomake_erlang_erlc_rebar3_profile = 'test'

    let ebins = neomake#makers#ft#erlang#EbinDirs(root)
    AssertEqual [root . '/_build/test/lib/dep1/ebin'], ebins
    bwipe
  finally
    execute 'cd ' . old_cwd
  endtry

Execute (erlang#EbinsToIncludes):
  let old_cwd = getcwd()
  try
    let root = tempname()
    call mkdir(root, 'p')
    execute 'cd ' . root
    new
    file src/myapp.erl
    " Project-level ebin/
    call mkdir('ebin', 'p')
    " Default profile - _build/default/lib/dep1/ebin/
    call mkdir('_build/default/lib/dep1/ebin', 'p')

    let ebins = neomake#makers#ft#erlang#EbinDirs(root)
    let includes = neomake#makers#ft#erlang#EbinsToIncludes(ebins)
    AssertEqual [ root . '/include',
                \ root . '/_build/default/lib/dep1/include'], includes
    bwipe
  finally
    execute 'cd ' . old_cwd
  endtry
